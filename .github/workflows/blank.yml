name: Termux CI (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  termux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Pull Android Emulator Image
        run: docker pull halimqarroum/docker-android:api-30

      - name: Start Android Emulator
        run: |
          docker run -d \
            --name android \
            --privileged \
            -e DEVICE=pixel \
            -e EMULATOR_ARGS="-no-window -no-audio -no-boot-anim" \
            halimqarroum/docker-android:api-30

      - name: Wait Emulator READY
        run: |
          docker exec android bash -c '
            adb start-server
            until adb devices | grep "emulator-5554[[:space:]]*device"; do sleep 5; done
            until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 5; done
            echo "✅ Emulator ready"
          '

      - name: Download Termux APK (F-Droid)
        run: |
          docker exec android bash -c '
            curl -L -o /tmp/termux.apk https://f-droid.org/repo/com.termux_118.apk
          '

      - name: Install Termux
        run: |
          docker exec android bash -c '
            adb install -r /tmp/termux.apk
          '

      - name: Launch Termux once (init)
        run: |
          docker exec android bash -c '
            adb shell monkey -p com.termux -c android.intent.category.LAUNCHER 1
            sleep 20
          '

      - name: Run Termux commands (ROOT METHOD – WORKING)
        run: |
          docker exec android bash -c '
            adb shell su -c "
              export HOME=/data/data/com.termux/files/home
              export PREFIX=/data/data/com.termux/files/usr
              export PATH=\$PREFIX/bin:\$PATH
              \$PREFIX/bin/bash -lc \"
                pkg update -y
                pkg upgrade -y
                pkg install -y libjansson build-essential clang binutils git
              \"
            "
          '
