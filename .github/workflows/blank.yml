name: Termux CI (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  termux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ===============================
      # Cache Termux APK
      # ===============================
      - name: Cache Termux APK
        uses: actions/cache@v4
        with:
          path: termux.apk
          key: termux-apk-118

      - name: Download Termux APK (cached)
        run: |
          if [ ! -f termux.apk ]; then
            curl -L -o termux.apk https://f-droid.org/repo/com.termux_118.apk
          fi

      # ===============================
      # Android Emulator
      # ===============================
      - name: Pull Emulator Image
        run: docker pull halimqarroum/docker-android:api-30

      - name: Start Emulator
        run: |
          docker run -d \
            --name android \
            --privileged \
            -e DEVICE=pixel \
            -e EMULATOR_ARGS="-no-window -no-audio -no-boot-anim" \
            halimqarroum/docker-android:api-30

      - name: Wait Emulator READY
        run: |
          docker exec android bash -c '
            adb start-server
            until adb devices | grep emulator-5554; do sleep 5; done
            until adb shell getprop sys.boot_completed | grep 1; do sleep 5; done
            until adb shell pm list packages >/dev/null 2>&1; do sleep 5; done
          '

      # ===============================
      # Install Termux
      # ===============================
      - name: Install Termux
        run: |
          docker cp termux.apk android:/tmp/termux.apk
          docker exec android adb install -r /tmp/termux.apk

      - name: Launch Termux once
        run: |
          docker exec android adb shell monkey \
            -p com.termux \
            -c android.intent.category.LAUNCHER 1
          sleep 20

      # ===============================
      # RUN TERMUX (OUTPUT FIXED)
      # ===============================
      - name: Run Termux package commands (VISIBLE OUTPUT)
        run: |
          docker exec -t android adb shell su -c '
            export HOME=/data/data/com.termux/files/home
            export PREFIX=/data/data/com.termux/files/usr
            export PATH=$PREFIX/bin:$PATH

            echo "=== TERMUX ENV ==="
            whoami
            echo $PREFIX
            echo "================="

            pkg update -y
            pkg upgrade -y
            pkg install -y libjansson build-essential clang binutils git
          '
