name: Termux CI - Build CCMINER (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  termux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout repo
        uses: actions/checkout@v4

      # ===============================
      # Download Termux DEBUG APK
      # ===============================
      - name: Download Termux DEBUG APK
        run: |
          set -e
          URL="https://github.com/termux/termux-app/releases/download/v0.119.0-beta.2/termux-app_v0.119.0-beta.2+apt-android-7-github-debug_x86_64.apk"
          curl -fL --retry 5 --retry-delay 5 -o termux.apk "$URL"
          file termux.apk | grep -q "Android package"

      # ===============================
      # Android Emulator (Docker)
      # ===============================
      - name: Pull Android Emulator Image
        run: docker pull halimqarroum/docker-android:api-30

      - name: Start Android Emulator
        run: |
          docker run -d \
            --name android \
            --privileged \
            -e DEVICE=pixel \
            -e EMULATOR_ARGS="-no-window -no-audio -no-boot-anim" \
            halimqarroum/docker-android:api-30

      - name: Wait Emulator READY
        run: |
          docker exec android bash -c '
            adb start-server
            until adb devices | grep "emulator-5554.*device"; do sleep 5; done
            until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 5; done
            until adb shell pm list packages >/dev/null 2>&1; do sleep 5; done
            echo "✅ Emulator READY"
          '

      # ===============================
      # Install Termux
      # ===============================
      - name: Install Termux
        run: |
          docker cp termux.apk android:/tmp/termux.apk
          docker exec android adb install --no-streaming -r /tmp/termux.apk
          docker exec android adb shell '
            monkey -p com.termux -c android.intent.category.LAUNCHER 1
            sleep 25
          '

      # ===============================
      # Termux Build Script
      # ===============================
      - name: Create Termux build script
        run: |
          cat <<'EOF' > termux.sh
          #!/data/data/com.termux/files/usr/bin/bash
          set -euo pipefail

          export HOME=/data/data/com.termux/files/home
          export PREFIX=/data/data/com.termux/files/usr
          export PATH=$PREFIX/bin:$PATH

          echo "=== TERMUX ENV ==="
          whoami
          id
          uname -a

          if [ "$(id -u)" = "0" ]; then
            echo "❌ ERROR: running as root"
            exit 1
          fi

          echo ===============================
          echo Update & deps
          echo ===============================
          yes | pkg update
          yes | pkg upgrade -y

          yes | pkg install \
            git \
            clang \
            make \
            autoconf \
            automake \
            libtool \
            pkg-config \
            openssl \
            openssl-dev \
            libcurl \
            libcurl-dev \
            zlib \
            zlib-dev \
            -y

          echo ===============================
          echo Build CCMINER (CPU ONLY)
          echo ===============================
          cd $HOME
          git clone https://github.com/Oink70/ccminer.git
          cd ccminer

          export CC=clang
          export CXX=clang++
          export CFLAGS="-O2"
          export LDFLAGS=""

          ./autogen.sh

          ./configure \
            --disable-cuda \
            --disable-opencl \
            --with-crypto \
            --prefix=$PREFIX

          make -j$(nproc)

          echo "=== BUILD RESULT ==="
          file ccminer
          ./ccminer --help || true

          echo "✅ CCMINER BUILD SUCCESS"
          EOF


          docker cp termux.sh android:/tmp/termux.sh
          docker exec android adb push /tmp/termux.sh /data/local/tmp/termux.sh
          docker exec android adb shell chmod 755 /data/local/tmp/termux.sh


      # ===============================
      # Run Termux Script
      # ===============================
      - name: Run Termux build
        run: |
          docker exec android adb shell '
            run-as com.termux \
              /data/data/com.termux/files/usr/bin/bash \
              /data/local/tmp/termux.sh
          '
