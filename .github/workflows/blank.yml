name: Termux CI (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  termux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Pull Android Emulator Image
        run: |
          docker pull halimqarroum/docker-android:api-30

      - name: Start Android Emulator (Docker)
        run: |
          docker run -d \
            --name android \
            --privileged \
            -e DEVICE=pixel \
            -e EMULATOR_ARGS="-no-window -no-audio -no-boot-anim" \
            halimqarroum/docker-android:api-30

      - name: Show Docker Status (debug)
        run: |
          docker ps
          docker logs android --tail 50

      - name: Wait for Emulator Boot (INSIDE CONTAINER)
        run: |
          docker exec android bash -c '
            adb start-server
            echo "Waiting emulator..."
            until adb devices | grep emulator; do sleep 5; done
            echo "Waiting boot_completed..."
            until adb shell getprop sys.boot_completed | grep 1; do sleep 5; done
            echo "Emulator READY"
          '

      - name: Download Termux APK
        run: |
          docker exec android bash -c '
            curl -L -o /tmp/termux.apk \
            https://github.com/termux/termux-app/releases/latest/download/termux-app_v0.118.0+github-debug_universal.apk
          '

      - name: Install & Launch Termux
        run: |
          docker exec android bash -c '
            adb install -r /tmp/termux.apk
            adb shell monkey -p com.termux 1
            sleep 15
          '

      - name: Run Termux Package Commands
        run: |
          docker exec android bash -c '
            adb shell "pkg update -y"
            adb shell "pkg upgrade -y"
            adb shell "pkg install -y libjansson build-essential clang binutils git"
          '
