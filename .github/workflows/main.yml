name: Build cpuminer (Termux / Android)

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NDK_VERSION: r26d
      API_LEVEL: 30
      TARGET: aarch64-linux-android
      PREFIX: /opt/termux
      OPENSSL_VERSION: 3.3.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: wong-fi-hung/termux-miner

      # =========================
      # Cache Android NDK
      # =========================
      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: ~/android-ndk
          key: ndk-${{ env.NDK_VERSION }}

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip
          mv android-ndk-${NDK_VERSION} ~/android-ndk

      # =========================
      # Toolchain env
      # =========================
      - name: Setup Toolchain
        run: |
          echo "$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # =========================
      # Cache OpenSSL source
      # =========================
      - name: Cache OpenSSL source
        uses: actions/cache@v4
        id: cache-openssl-src
        with:
          path: openssl
          key: openssl-src-${{ env.OPENSSL_VERSION }}

      # =========================
      # Cache OpenSSL build (PREFIX)
      # =========================
      - name: Cache OpenSSL build
        uses: actions/cache@v4
        id: cache-openssl-build
        with:
          path: ${{ env.PREFIX }}
          key: openssl-build-${{ env.OPENSSL_VERSION }}-${{ env.TARGET }}

      # =========================
      # Build OpenSSL (ONLY if cache miss)
      # =========================
      - name: Build OpenSSL (static)
        if: steps.cache-openssl-build.outputs.cache-hit != 'true'
        run: |
          export ANDROID_NDK_HOME=$HOME/android-ndk
          export ANDROID_API=${API_LEVEL}
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          if [ ! -f openssl-${OPENSSL_VERSION}.tar.gz ]; then
            wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          fi

          rm -rf openssl
          tar xf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}

          export CC=${TARGET}${ANDROID_API}-clang
          export AR=llvm-ar
          export RANLIB=llvm-ranlib

          ./Configure android-arm64 \
            no-shared \
            no-tests \
            --prefix=$PREFIX \
            --openssldir=$PREFIX/ssl

          make -j$(nproc)
          make install_sw
