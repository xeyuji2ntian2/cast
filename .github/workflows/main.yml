name: Build cpuminer for Termux (Android arm64)

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ===============================
      # Checkout source
      # ===============================
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          repository: wong-fi-hung/termux-miner

      # ===============================
      # System deps
      # ===============================
      - name: Install build dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y -qq \
            git \
            make \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            unzip

      # ===============================
      # Cache Android NDK
      # ===============================
      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: android-ndk-r26d
          key: ndk-r26d-${{ runner.os }}

      # ===============================
      # Download NDK (cache miss only)
      # ===============================
      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip

      # ===============================
      # Set NDK env
      # ===============================
      - name: Set NDK environment
        run: |
          echo "NDK=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          echo "TOOLCHAIN=$PWD/android-ndk-r26d/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
          echo "TARGET=aarch64-linux-android" >> $GITHUB_ENV
          echo "API=21" >> $GITHUB_ENV
