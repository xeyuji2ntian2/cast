name: Build cpuminer (Termux / Android)

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NDK_VERSION: r26d
      API_LEVEL: 30
      TARGET: aarch64-linux-android
      PREFIX: /opt/termux
      OPENSSL_VERSION: openssl-3.3.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: wong-fi-hung/termux-miner

      # =========================
      # Cache Android NDK
      # =========================
      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: ~/android-ndk
          key: ndk-${{ env.NDK_VERSION }}

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip
          mv android-ndk-${NDK_VERSION} ~/android-ndk

      # =========================
      # Toolchain env
      # =========================
      - name: Setup Toolchain
        run: |
          echo "$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # =========================
      # Cache OpenSSL source
      # =========================
      - name: Cache OpenSSL source
        uses: actions/cache@v4
        id: cache-openssl-src
        with:
          path: openssl
          key: openssl-src-${{ env.OPENSSL_VERSION }}

      # =========================
      # Cache OpenSSL build (PREFIX)
      # =========================
      - name: Cache OpenSSL build
        uses: actions/cache@v4
        id: cache-openssl-build
        with:
          path: ${{ env.PREFIX }}
          key: openssl-build-${{ env.OPENSSL_VERSION }}-${{ env.TARGET }}

      # =========================
      # Build OpenSSL (ONLY if cache miss)
      # =========================
      - name: Build OpenSSL (static)
        if: steps.cache-openssl-build.outputs.cache-hit != 'true'
        run: |
          if [ ! -d openssl ]; then
            git clone --branch ${OPENSSL_VERSION} --depth 1 https://github.com/openssl/openssl.git
          fi

          cd openssl
          ./Configure android-arm64 no-shared no-tests \
            --prefix=$PREFIX \
            --openssldir=$PREFIX/ssl

          make -j$(nproc)
          make install_sw

