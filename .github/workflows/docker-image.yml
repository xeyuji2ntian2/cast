name: Termux CI - Build CCMINER (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  build-ccminer:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            autoconf \
            automake \
            libtool \
            pkg-config \
            make \
            clang \
            curl \
            unzip

      - name: Download Android NDK r21e
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip -q ndk.zip
          echo "NDK=$PWD/android-ndk-r21e" >> $GITHUB_ENV

      - name: Clone ccminer
        run: |
          git clone --depth=1 https://github.com/Darktron/armccminer.git
          cd armccminer
          ./autogen.sh

      - name: Cross compile ccminer (ARMv7)
        run: |
          cd armccminer
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          export TARGET=armv7a-linux-androideabi
          export API=21

          export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
          export CXX=$TOOLCHAIN/bin/${TARGET}${API}-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          ./configure \
            --host=arm-linux-androideabi \
            CFLAGS="-O2 -march=armv7-a -mfpu=neon -mfloat-abi=softfp"

          make -j$(nproc)
          $STRIP ccminer

      - name: Upload ccminer binary
        uses: actions/upload-artifact@v4
        with:
          name: ccminer-armv7
          path: armccminer/ccminer

  termux:
    needs: build-ccminer
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout repo
        uses: actions/checkout@v4

      # ===============================
      # Download Termux APK (ARMv7)
      # ===============================
      - name: Download Termux APK (ARMv7)
        run: |
          set -e
          URL="https://github.com/termux/termux-app/releases/download/v0.118.3/termux-app_v0.118.3+github-debug_armeabi-v7a.apk"
          curl -fL --retry 5 --retry-delay 5 -o termux.apk "$URL"
          file termux.apk | grep -q "Android package"

      # ===============================
      # Android Emulator (Docker)
      # ===============================
      - name: Pull Android Emulator Image
        run: docker pull svijayakumar/docker-android-arm-7.1.1

      - name: Start Android Emulator
        run: |
          docker run -d \
            --name android \
            --privileged \
            -p 5555:5555 \
            -p 6080:6080 \
            svijayakumar/docker-android-arm-7.1.1

      # ===============================
      # Wait Emulator READY
      # ===============================
      - name: Wait Emulator READY
        run: |
          docker exec android bash -c '
            adb start-server
            until adb devices | grep -E "emulator-[0-9]+.*device"; do adb devices; sleep 5; done
            until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 5; done

            echo "âœ… Emulator READY"
          '

      # ===============================
      # Install Termux
      # ===============================
      - name: Install Termux
        run: |
          docker cp termux.apk android:/tmp/termux.apk
          docker exec android adb install -r /tmp/termux.apk
          docker exec android adb shell '
            monkey -p com.termux -c android.intent.category.LAUNCHER 1
            sleep 30
          '

      # ===============================
      # Prepare Termux
      # ===============================
      - name: Initialize Termux
        run: |
          docker exec android adb shell '
            run-as com.termux mkdir -p /data/data/com.termux/files/home
            run-as com.termux touch /data/data/com.termux/files/home/.initialized
          '
      - name: Download ccminer artifact
        uses: actions/download-artifact@v4
        with:
          name: ccminer-armv7
          path: .

      - name: Push ccminer to Termux
        run: |
          docker exec android adb push ccminer /data/local/tmp/ccminer
          docker exec android adb shell '
            run-as com.termux cp /data/local/tmp/ccminer /data/data/com.termux/files/home/ccminer
            run-as com.termux chmod +x /data/data/com.termux/files/home/ccminer
          '
      # ===============================
      # Copy build script
      # ===============================
      - name: Copy Termux build script
        run: |
          docker exec android adb push termux.sh /data/local/tmp/termux.sh
          docker exec android adb shell '
            run-as com.termux cp /data/local/tmp/termux.sh /data/data/com.termux/files/home/termux.sh
            run-as com.termux chmod +x /data/data/com.termux/files/home/termux.sh
          '

      # ===============================
      # Run Termux build
      # ===============================
      - name: Run Termux build
        run: |
          docker exec android adb shell '
            run-as com.termux \
              /data/data/com.termux/files/usr/bin/bash \
              -lc "cd ~ && ./termux.sh"
          '
