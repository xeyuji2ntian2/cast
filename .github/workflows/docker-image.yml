name: Termux CI - Build CCMINER (Android Emulator)

on:
  push:
  workflow_dispatch:

jobs:
  termux:
    runs-on: ubuntu-latest

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ===============================
      # Download Termux DEBUG APK
      # ===============================
      - name: Download Termux DEBUG APK
        run: |
          set -e
          URL="https://github.com/termux/termux-app/releases/download/v0.119.0-beta.2/termux-app_v0.119.0-beta.2+apt-android-7-github-debug_x86_64.apk"
          curl -fL --retry 5 --retry-delay 5 -o termux.apk "$URL"
          file termux.apk | grep -q "Android package"

      # ===============================
      # Android Emulator (Docker)
      # ===============================
      - name: Pull Android Emulator Image
        run: docker pull ghcr.io/xeyuji2ntian2/docker-android:api-30

      - name: Start Android Emulator
        run: |
          docker run -d \
            --name android \
            --privileged \
            -e DEVICE=pixel \
            -e EMULATOR_ARGS="-no-window -no-audio -no-boot-anim" \
            ghcr.io/xeyuji2ntian2/docker-android:api-30

      - name: Wait Emulator READY
        run: |
          docker exec android bash -c '
            adb start-server
            until adb devices | grep "emulator-5554.*device"; do sleep 5; done
            until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 5; done
            until adb shell pm list packages >/dev/null 2>&1; do sleep 5; done
            echo "‚úÖ Emulator READY"
          '

      # ===============================
      # Install Termux
      # ===============================
      - name: Install Termux
        run: |
          docker cp termux.apk android:/tmp/termux.apk
          docker exec android adb install --no-streaming -r /tmp/termux.apk
          docker exec android adb shell '
            monkey -p com.termux -c android.intent.category.LAUNCHER 1
            sleep 25
          '

      # ===============================
      # Initial termux.sh
      # ===============================
      - name: Prepare termux.sh
        run: |
          curl -fL \
            https://raw.githubusercontent.com/${{ github.repository }}/main/termux.sh \
            -o termux.sh

      - name: Push termux.sh to emulator
        run: |
          docker cp termux.sh android:/tmp/termux.sh
          docker exec android adb push /tmp/termux.sh /data/local/tmp/termux.sh
          docker exec android adb shell chmod 755 /data/local/tmp/termux.sh
          docker exec android adb shell \
            "run-as com.termux cp /data/local/tmp/termux.sh /data/data/com.termux/files/home/termux.sh"
          docker exec android adb shell \
            "run-as com.termux chmod +x /data/data/com.termux/files/home/termux.sh"

      # ===============================
      # Run Termux Script (retry + wait if unchanged)
      # ===============================
      - name: Run Termux build (smart retry)
        run: |
          set +e

          MAX_RETRY=50
          RETRY=0
          SUCCESS=0

          while [ $RETRY -lt $MAX_RETRY ]; do
            echo "üöÄ Attempt $((RETRY+1)) / $MAX_RETRY"

            docker exec android adb shell \
              "run-as com.termux /data/data/com.termux/files/usr/bin/bash -c \
              'cd /data/data/com.termux/files/home && ./termux.sh'"

            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ termux.sh SUCCESS"
              SUCCESS=1
              break
            fi

            echo "‚ùå termux.sh FAILED (exit=$EXIT_CODE)"
            echo "üîç Checking if termux.sh changed..."

            OLD_HASH=""
            if [ -f termux.sh ]; then
              OLD_HASH=$(sha256sum termux.sh | awk '{print $1}')
            fi

            UPDATED=0
            CHECK=0
            MAX_CHECK=100

            while [ $CHECK -lt $MAX_CHECK ]; do
              curl -fsL \
                https://raw.githubusercontent.com/${{ github.repository }}/main/termux.sh \
                -o termux.sh.new || true

              if [ ! -s termux.sh.new ]; then
                sleep 15
                CHECK=$((CHECK+1))
                continue
              fi

              NEW_HASH=$(sha256sum termux.sh.new | awk '{print $1}')

              if [ "$NEW_HASH" != "$OLD_HASH" ]; then
                echo "‚úÖ termux.sh UPDATED"
                mv termux.sh.new termux.sh
                UPDATED=1
                break
              fi

              echo "‚è≥ termux.sh unchanged, waiting 20s... $CHECK"
              sleep 20
              echo "------------------------------------------------------------"
              echo "------------------------------------------------------------"
              echo "------------------------------------------------------------"
              CHECK=$((CHECK+1))
            done

            rm -f termux.sh.new

            if [ $UPDATED -eq 1 ]; then
              docker cp termux.sh android:/tmp/termux.sh
              docker exec android adb push /tmp/termux.sh /data/local/tmp/termux.sh
              docker exec android adb shell chmod 755 /data/local/tmp/termux.sh
              docker exec android adb shell \
                "run-as com.termux cp /data/local/tmp/termux.sh /data/data/com.termux/files/home/termux.sh"
              docker exec android adb shell \
                "run-as com.termux chmod +x /data/data/com.termux/files/home/termux.sh"
            fi

            echo "‚è≥ Waiting 5s before next attempt..."
            sleep 5
            RETRY=$((RETRY+1))
          done

          if [ $SUCCESS -ne 1 ]; then
            echo "üí• termux.sh FAILED after $MAX_RETRY attempts"
            exit 1
          fi
